<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple User Login Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-user { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid #007bff; }
        .test-user h3 { margin: 0 0 10px 0; color: #333; }
        .test-user button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .test-user button:hover { background: #0056b3; }
        .test-user button:disabled { background: #6c757d; cursor: not-allowed; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .clear-session { background: #dc3545; margin: 20px 0; }
        .clear-session:hover { background: #c82333; }
        .session-info { background: #e7f3ff; padding: 15px; margin: 20px 0; border-radius: 6px; }
        .logs { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; margin: 20px 0; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Multiple User Login Test</h1>
        <p>Test logging in with different users to identify session conflicts.</p>
        
        <div class="session-info">
            <h3>Current Session Status:</h3>
            <div id="sessionStatus">Not checked yet</div>
        </div>

        <button class="test-user clear-session" onclick="clearSession()">üóëÔ∏è Clear All Session Data</button>
        
        <div class="test-user">
            <h3>üëë Tony967 (Superuser)</h3>
            <button onclick="testLogin('tony967', 'AhFnrAASWN0a', 'tony967')">Login as Tony</button>
            <div id="result-tony967" class="result" style="display: none;"></div>
        </div>

        <div class="test-user">
            <h3>üë§ Adam585 (User/Operator)</h3>
            <button onclick="testLogin('adam585', '5AdsYCEqrrIg', 'adam585')">Login as Adam</button>
            <div id="result-adam585" class="result" style="display: none;"></div>
        </div>

        <div class="test-user">
            <h3>üë®‚Äçüíº Max463 (Manager)</h3>
            <button onclick="testLogin('max463', 'CCiYxAAxyR0z', 'max463')">Login as Max</button>
            <div id="result-max463" class="result" style="display: none;"></div>
        </div>

        <div class="test-user">
            <h3>üëë Preet858 (Superuser)</h3>
            <button onclick="testLogin('preet858', 'AaWtgE1hRECG', 'preet858')">Login as Preet</button>
            <div id="result-preet858" class="result" style="display: none;"></div>
        </div>

        <div class="test-user">
            <h3>üë§ Bob771 (User)</h3>
            <button onclick="testLogin('bob771', 'n6mTWAOhVDda', 'bob771')">Login as Bob</button>
            <div id="result-bob771" class="result" style="display: none;"></div>
        </div>

        <div class="logs">
            <h3>üîç Test Logs:</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let testCount = 0;

        function log(message) {
            testCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `<div>[${testCount}] ${timestamp}: ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${testCount}] ${message}`);
        }

        function updateSessionStatus() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            const lastLogin = localStorage.getItem('lastLogin');
            
            const statusDiv = document.getElementById('sessionStatus');
            
            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    const loginTime = lastLogin ? new Date(lastLogin).toLocaleString() : 'Unknown';
                    statusDiv.innerHTML = `
                        <strong>‚úÖ Active Session</strong><br>
                        User: ${userData.full_name} (${userData.username})<br>
                        Roles: ${userData.roles.map(r => r.name).join(', ')}<br>
                        Login Time: ${loginTime}<br>
                        Token: ${token.substring(0, 20)}...
                    `;
                } catch (e) {
                    statusDiv.innerHTML = `<strong>‚ùå Invalid Session Data</strong><br>Error: ${e.message}`;
                }
            } else {
                statusDiv.innerHTML = `<strong>üö´ No Active Session</strong>`;
            }
        }

        function clearSession() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('user');
            localStorage.removeItem('userSettings');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('lastLogin');
            localStorage.removeItem('currentUser');
            sessionStorage.clear();
            
            log('üóëÔ∏è Session cleared completely');
            updateSessionStatus();
            
            // Clear all result divs
            document.querySelectorAll('.result').forEach(div => {
                div.style.display = 'none';
                div.innerHTML = '';
            });
        }

        async function testLogin(username, password, resultId) {
            const button = event.target;
            const resultDiv = document.getElementById(`result-${resultId}`);
            
            button.disabled = true;
            button.textContent = 'Logging in...';
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = 'Attempting login...';
            
            log(`üîÑ Attempting login for ${username}`);
            
            try {
                // Clear session before login
                localStorage.removeItem('accessToken');
                localStorage.removeItem('user');
                localStorage.removeItem('userSettings');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('lastLogin');
                localStorage.removeItem('currentUser');
                sessionStorage.clear();
                
                await new Promise(resolve => setTimeout(resolve, 200)); // Small delay
                
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.access_token || !data.user) {
                    throw new Error('Invalid response format');
                }
                
                // Store session data
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('user', JSON.stringify(data.user));
                localStorage.setItem('lastLogin', new Date().toISOString());
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Login Successful</strong><br>
                    User: ${data.user.full_name}<br>
                    Roles: ${data.user.roles.map(r => r.name).join(', ')}<br>
                    Tools: ${data.user.tools.map(t => t.display_name).join(', ') || 'None'}<br>
                    Token: ${data.access_token.substring(0, 30)}...
                `;
                
                log(`‚úÖ Login successful for ${username} (${data.user.full_name})`);
                updateSessionStatus();
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Login Failed</strong><br>
                    Error: ${error.message}
                `;
                log(`‚ùå Login failed for ${username}: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = `Login as ${username.charAt(0).toUpperCase() + username.slice(1)}`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('üìã Multiple login test page loaded');
            updateSessionStatus();
            
            // Update session status every 10 seconds
            setInterval(updateSessionStatus, 10000);
        });
    </script>
</body>
</html>